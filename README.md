# Op-Sep: Separate Your Data from your Keys
Use strong cryptography and simple rate-limting to operationally separate your data from your keys.
Reduce the damage of data-breaches 100x (and maintain an audit log to measure exposure).

## Setup

### Fetch repo:
```bash
$ git clone git@github.com:opsep/opsep-server.git && cd opsep-server
```

### Run the server
Use [reflex](https://github.com/cespare/reflex) to reload the server in development:
```bash
$ RSA_PRIVATE_KEY="$(cat insecure_certs/priv.pem)" go run *.go
```

### Test that it's working:
This will also output the (public) config settings:
```bash
$ curl localhost:8080 
{
  "SQLiteFilePath": "opsep.sqlite3",
  "SeverHost": "localhost",
  "ServerPort": "8080",
  "RSAPubKey": "-----BEGIN RSA PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA7q4R3soRD2CrjL13OK6Y\nSBG8wpjP5sbfkL0QhpJMH87grlR2SS3CUnbYCOONzQiJ3OuKAViy/lMw1KsmG9Nn\nhAot2acg1iNyZRY33LR2jwmfFF+2iRp0itPQeOHY6GS8m3WLCMtC/kWUq0Bl5g1P\nYa9JXwSkTTRJunNH0TPk8uqwFeVhpT336M1H6ed105L8a8W3mpSwlwePron7pLf7\nwD32m9RT0nNdnHBDQCsUKS/Gdp+saLYWTgj0rpnQCe8f1p3g36Gm0gTzr3X0Adow\n8gIPfxO4HU/0cdL+Pw4mpcsWJ4531taRLLGb+a2la2zAUteYcS+8d4Nb8Omkbz39\nPylvKP6R1kHElqlF3BnwUp0AdcAvOLdeX8kYUlbKE8xwjHm/KwwleKlcAZDam7hC\nRw72JUQiod0E7My+SiZ3Ij5zKnxZXmAF5BX8T+YSqSzR4Qdp2QU9L9GgAZo/HPBN\nwME9v8usjEzrEItSSg3Nn10+J+ygsCqjrCT8CnSvD8wEyDSdO/Jly9DnWJ6B2HJE\nOc4wxWGFTCE0wiQOwC3IPNxFhuWun6/4tsEQcDs5XHaBXIHry5WCiVkjwa2pc95x\niXcfoQWr1A/jLe/MrZyN4yrgDK9mmQxxNzVfLj8S9NPjJMv+K7BKvtOmvoqsf13K\n6hYJGkAdR0d99DNFlllRm7cCAwEAAQ==\n-----END RSA PUBLIC KEY-----\n",
  "DecryptsAllowedPerPeriod": 100,
  "PeriodInSeconds": 600
}
```

## Use

### Encryption

Encrypt a key locally (this would be randomly generated by your client library):
```bash
$ to_decrypt=$(echo "{\"key\":\"00000000000000000000000000000000\"}" | openssl pkeyutl -encrypt -pubin -inkey insecure_certs/crt.pub -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -pkeyopt rsa_mgf1_md:sha256 | base64)
```
(you can see this with `$ echo $to_decrypt`)

### Decryption

Make an API call to decrypt the file you just made:
```bash
$ curl -X POST localhost:8080/api/v1/decrypt -H 'Content-Type: application/json' -d '{"key_retrieval_ciphertext":"'$(echo $to_decrypt)'"}' | python -m json.tool
{
    "key_recovered": "00000000000000000000000000000000",
    "request_sha256": "1e16673d9b0bb33e7cfb84d6c0bf96970f3cfc34c4f7f41987bd624c0912f69a",
    "ratelimit_limit": 100,
    "ratelimit_remaining": 99,
    "ratelimit_resets_in": 599
}
```

### Audit Logging:
Calculate the hash of the file your decryption request:
```bash
$ echo $to_decrypt | base64 --decode | shasum -a 256
55a80d54fd68dea27f4186a9f6466082f02af25939546d974eb19c3eee4e4114  -
```
(your result will be different, as asymmetric encryption uses a randomly generated nonce each time it is run)

Query to see all past decrypts for a specific record:
```bash
$ curl localhost:8080/api/v1/logs/55a80d54fd68dea27f4186a9f6466082f02af25939546d974eb19c3eee4e4114 | python -m json.tool
[
    {
        "ServerLogID": 18,
        "CreatedAt": "2020-08-11T18:10:09Z",
        "RequestSha256Digest": "55a80d54fd68dea27f4186a9f6466082f02af25939546d974eb19c3eee4e4114",
        "RequestIPAddress": "127.0.0.1",
        "RequestUserAgent": "curl/7.64.1",
        "ClientRecordID": null,
        "DeprecateAt": null,
        "RiskMultiplier": null
    }
]

```

Worried about a breach? See all decrypts as CSV:
```bash
$ sqlite3 opsep.sqlite3 -header -csv 'SELECT * FROM api_calls;'
```

### Key Deprecation
Make your data auto-expire at a certain date (not that the data can still be recovered if you have your Key Encryption Key, but it is not defualt accessible via this service):
```bash
$ to_decrypt=$(echo "{\"key\":\"00000000000000000000000000000000\", \"deprecate_at\":\"2020-01-01T12:00:00Z\"}" | openssl pkeyutl -encrypt -pubin -inkey insecure_certs/crt.pub -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -pkeyopt rsa_mgf1_md:sha256 | base64)
$ curl -X POST localhost:8080/api/v1/decrypt -H 'Content-Type: application/json' -d '{"key_retrieval_ciphertext":"'$(echo $to_decrypt)'"}' | python -m json.tool
{
    "error_name": "DeprecatedDecryptionKeyError",
    "error_description": "Key to decrypt this payload marked as deprecated."
}
```

### Details

#### One-Liner
Regular:
```bash
$ curl -s -X POST localhost:8080/api/v1/decrypt -H 'Content-Type: application/json' -d '{"key_retrieval_ciphertext":"'$(echo "{\"key\":\"00000000000000000000000000000000\"}" | openssl pkeyutl -encrypt -pubin -inkey insecure_certs/crt.pub -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -pkeyopt rsa_mgf1_md:sha256 | base64)'"}' | python -m json.tool
{
    "key_recovered": "00000000000000000000000000000000",
    "request_sha256": "df9e875c1670896d1213f6fa401f12ce4bcfdc047d0ab050620f70626db53b89",
    "ratelimit_limit": 100,
    "ratelimit_remaining": 99,
    "ratelimit_resets_in": 599
}

```

Expired key:
```bash
$ curl -s -X POST localhost:8080/api/v1/decrypt -H 'Content-Type: application/json' -d '{"key_retrieval_ciphertext":"'$(echo "{\"key\":\"00000000000000000000000000000000\", \"deprecate_at\":\"2020-01-01T12:00:00Z\"}" | openssl pkeyutl -encrypt -pubin -inkey insecure_certs/crt.pub -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -pkeyopt rsa_mgf1_md:sha256 | base64)'"}' | python -m json.tool
{
    "error_name": "DeprecatedDecryptionKeyError",
    "error_description": "Key to decrypt this payload marked as deprecated."
}
```

Fancy. In addition to `key` we include `deprecate_at`, `client_record_id`, and `risk_multiplier`):
```bash
$ curl -s -X POST localhost:8080/api/v1/decrypt -H 'Content-Type: application/json' -d '{"key_retrieval_ciphertext":"'$(echo "{\"key\":\"00000000000000000000000000000000\", \"deprecate_at\":\"2030-01-01T12:00:00Z\", \"client_record_id\":\"aaaaaaaa-0000-bbbb-1111-cccccccccccc\", \"risk_multiplier\":"3"}" | openssl pkeyutl -encrypt -pubin -inkey insecure_certs/crt.pub -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -pkeyopt rsa_mgf1_md:sha256 | base64)'"}' | python -m json.tool
{
    "key_recovered": "00000000000000000000000000000000",
    "request_sha256": "e505f29ab3da7fa6e02ef7cc2ff42bcef66cb4e2fff814ae8d36344306a07a40",
    "ratelimit_limit": 100,
    "ratelimit_remaining": 99,
    "ratelimit_resets_in": 599
}

```


#### Rate-Limit
If you want a rough test of 429-ing, you can do this:
```bash
$ for i in {1..99}; do curl [...] "http://localhost:8080/api/v1/decrypt" ; done
```

#### Create an RSA keypair

This is how the keypairs in `insecure_certs` were generated:
```bash
$ openssl genrsa -out insecure_certs/pem.priv 4096 && openssl rsa -in insecure_certs/pem.priv -pubout -out insecure_certs/crt.pub
Generating RSA private key, 4096 bit long modulus (2 primes)
...........................................++++
...............................++++
e is 65537 (0x010001)
writing RSA key
```

#### Extract Public Key from Opsep Server
To be sure that you're encrypting your data locally with the correct pubkey:
```bash
$ curl localhost:8080 | python3 -c "import sys, json; print(json.load(sys.stdin)['RSAPubKey'].strip())" | awk '{gsub(/\\n/,"\n")}1' > crt.pub
```
